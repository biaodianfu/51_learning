#include "config.h"
#include <stddef.h>
#include <string.h>

#if USE_LED_MATRIX_8x8_HC595
#include "led_matrix_8x8_hc595.h"

// Microbit风格图像函数库
const Image HEART = {{0x66, 0xFF, 0xFF, 0xFF, 0x7E, 0x3C, 0x18, 0x00}};
const Image HEART_SMALL = {{0x00, 0x6C, 0xFE, 0x7C, 0x38, 0x10, 0x00, 0x00}};
const Image HAPPY = {{0x3C, 0x42, 0xA5, 0x81, 0xA5, 0x99, 0x42, 0x3C}};
const Image SMILE = {{0x3C, 0x42, 0xA5, 0x81, 0x99, 0x99, 0x42, 0x3C}};
const Image SAD = {{0x3C, 0x42, 0xA5, 0x81, 0xA5, 0x99, 0x5A, 0x3C}};
const Image CONFUSED = {{0x3C, 0x42, 0xA5, 0x89, 0x91, 0x91, 0x42, 0x3C}};
const Image ANGRY = {{0x3C, 0x42, 0xA5, 0x81, 0xBD, 0x81, 0x42, 0x3C}};
const Image ASLEEP = {{0x3C, 0x42, 0x99, 0xA5, 0xA5, 0x99, 0x52, 0x3C}};
const Image SURPRISED = {{0x3C, 0x42, 0xA5, 0x81, 0xA5, 0x99, 0x5A, 0x3C}};
const Image SILLY = {{0x3C, 0x42, 0xA5, 0x81, 0x99, 0x89, 0x52, 0x3C}};
const Image FABULOUS = {{0x7E, 0x91, 0x61, 0x41, 0x61, 0x91, 0x7E, 0x00}};
const Image MEH = {{0x3C, 0x42, 0xA5, 0x81, 0xB9, 0x85, 0x42, 0x3C}};
const Image YES = {{0x00, 0x01, 0x03, 0x46, 0x6C, 0x38, 0x10, 0x00}}; // √
const Image NO = {{0xC3, 0x66, 0x3C, 0x18, 0x18, 0x3C, 0x66, 0xC3}}; // ×

// 箭头方向 (8种)
const Image ARROW_N = {{0x18, 0x3C, 0x7E, 0xFF, 0x18, 0x18, 0x18, 0x18}};
const Image ARROW_NE = {{0x80, 0xC0, 0xE2, 0x76, 0x3E, 0x1C, 0x08, 0x00}};
const Image ARROW_E = {{0x08, 0x0C, 0xFE, 0xFF, 0xFE, 0x0C, 0x08, 0x00}};
const Image ARROW_SE = {{0x00, 0x08, 0x1C, 0x3E, 0x76, 0xE2, 0xC0, 0x80}};
const Image ARROW_S = {{0x18, 0x18, 0x18, 0x18, 0xFF, 0x7E, 0x3C, 0x18}};
const Image ARROW_SW = {{0x02, 0x06, 0x8E, 0xDC, 0xF8, 0x70, 0x20, 0x00}};
const Image ARROW_W = {{0x00, 0x10, 0x30, 0x7F, 0xFF, 0x7F, 0x30, 0x10}};
const Image ARROW_NW = {{0x00, 0x20, 0x70, 0xF8, 0xDC, 0x8E, 0x06, 0x02}};

// 几何形状
const Image TRIANGLE = {{0x80, 0xC0, 0xE0, 0xF0, 0xE0, 0xC0, 0x80, 0x00}};
const Image TRIANGLE_LEFT = {{0x00, 0x08, 0x0C, 0xFE, 0xFF, 0x0C, 0x08, 0x00}};
const Image CHESSBOARD = {{0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55}};
const Image DIAMOND = {{0x18, 0x3C, 0x7E, 0xFF, 0xFF, 0x7E, 0x3C, 0x18}};
const Image DIAMOND_SMALL = {{0x00, 0x18, 0x3C, 0x7E, 0x7E, 0x3C, 0x18, 0x00}};
const Image SQUARE = {{0xFF, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0xFF}};
const Image SQUARE_SMALL = {{0x00, 0x3C, 0x24, 0x24, 0x24, 0x24, 0x3C, 0x00}};

// 动物和生物
const Image RABBIT = {{0x30, 0x5D, 0xDF, 0x5C, 0x30, 0x28, 0x34, 0x18}};
const Image COW = {{0x87, 0xC7, 0x7E, 0x38, 0x3C, 0x66, 0x43, 0x01}};
const Image DUCK = {{0x00, 0x0C, 0x1F, 0x1F, 0x1C, 0x7E, 0x4C, 0x00}};
const Image TORTOISE = {{0x18, 0x7E, 0xFF, 0x5A, 0x5A, 0x7E, 0x18, 0x00}};
const Image BUTTERFLY ={{0x99, 0x5A, 0x3C, 0xFF, 0xFF, 0x3C, 0x5A, 0x99}};
const Image STICKFIGURE = {{0x18, 0x18, 0x18, 0x3C, 0x99, 0x42, 0x24, 0x18}};
const Image GHOST = {{0x7E, 0xFF, 0xC3, 0xDB, 0xDB, 0xDB, 0xE7, 0x66}};
const Image GIRAFFE = {{0x30, 0x30, 0x38, 0x7C, 0xE6, 0x0F, 0x19, 0x18}};
const Image SKULL = {{0x3C, 0x7E, 0xC3, 0xDB, 0xC3, 0xDB, 0x7E, 0x3C}};
const Image SNAKE = {{0x00, 0x00, 0x76, 0xDF, 0xDB, 0x76, 0x00, 0x00}};

// 物品
const Image MUSIC_CROTCHET = {{0x0C, 0x0C, 0x0C, 0x0C, 0x38, 0x60, 0x7E, 0x3C}};
const Image MUSIC_QUAVER = {{0x18, 0x18, 0x18, 0x18, 0x70, 0xC0, 0xFE, 0x7C}};
const Image MUSIC_QUAVERS = {{0x66, 0x66, 0x66, 0x66, 0xE6, 0x06, 0xFC, 0xF8}};
const Image PITCHFORK = {{0x28, 0x28, 0x28, 0xEF, 0x28, 0x28, 0x28, 0x28}};
const Image XMAS = {{0x18, 0x3C, 0x7E, 0xFF, 0x5A, 0x5A, 0x24, 0x24}};
const Image PACMAN = {{0x3C, 0x7E, 0xF3, 0xE1, 0xE1, 0xF3, 0x7E, 0x3C}};
const Image TARGET = {{0x3C, 0x42, 0x99, 0xA5, 0xA5, 0x99, 0x42, 0x3C}};
const Image TSHIRT = {{0x44, 0xEE, 0xFE, 0xFE, 0x7C, 0x38, 0x38, 0x38}};
const Image ROLLERSKATE = {{0x00, 0x5A, 0xBD, 0xBD, 0x99, 0xFF, 0x66, 0x00}};
const Image HOUSE = {{0x18, 0x3C, 0x7E, 0xDB, 0xFF, 0xDB, 0xC3, 0xC3}};
const Image SWORD = {{0x18, 0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0x18}};
const Image UMBRELLA = {{0x3C, 0x42, 0x99, 0xA1, 0x99, 0x89, 0x46, 0x3C}};
const Image SCISSORS = {{0x21, 0x73, 0x3F, 0x1E, 0x1E, 0x3F, 0x73, 0x21}};

// 预定义正方形动画图形
const unsigned char SQUARE_PATTERNS[5][8] = {
    {0xFF,0x81,0x81,0x81,0x81,0x81,0x81,0xFF}, //8x8正方形
    {0x00,0x7E,0x42,0x42,0x42,0x42,0x7E,0x00}, //6x6正方形
    {0x00,0x00,0x3C,0x24,0x24,0x3C,0x00,0x00}, //4x4正方形
    {0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00}, //2x2正方形
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}  //0x0正方形
};

// 重新设计字体数据，确保字符在8x8矩阵中居中显示
const __code unsigned char FONT_CENTERED[][8] = {
    // 0-9 (8x6字体，居中放置在8x8矩阵中)
    {0x00, 0x3C, 0x24, 0x24, 0x24, 0x24, 0x24, 0x3C}, // 0
    {0x00, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04}, // 1
    {0x00, 0x3C, 0x04, 0x04, 0x3C, 0x20, 0x20, 0x3C}, // 2
    {0x00, 0x3C, 0x04, 0x04, 0x3C, 0x04, 0x04, 0x3C}, // 3
    {0x00, 0x24, 0x24, 0x24, 0x3C, 0x04, 0x04, 0x04}, // 4
    {0x00, 0x3C, 0x20, 0x20, 0x3C, 0x04, 0x04, 0x3C}, // 5
    {0x00, 0x3C, 0x20, 0x20, 0x3C, 0x24, 0x24, 0x3C}, // 6 错误
    {0x00, 0x3C, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04}, // 7
    {0x00, 0x3C, 0x24, 0x24, 0x3C, 0x24, 0x24, 0x3C}, // 8
    {0x00, 0x3C, 0x24, 0x24, 0x3C, 0x04, 0x04, 0x04}, // 9

    // 大写字母A-Z (8x6字体)
    {0x18, 0x3C, 0x7E, 0x66, 0x7E, 0x7E, 0x66, 0x66}, // A
    {0x7C, 0x7E, 0x66, 0x7E, 0x7E, 0x66, 0x7E, 0x7C}, // B
    {0x3C, 0x7E, 0x60, 0x60, 0x60, 0x60, 0x7E, 0x3C}, // C
    {0x78, 0x7C, 0x66, 0x66, 0x66, 0x66, 0x7C, 0x78}, // D
    {0x7E, 0x7E, 0x60, 0x7C, 0x7C, 0x60, 0x7E, 0x7E}, // E
    {0x7E, 0x7E, 0x60, 0x7C, 0x7C, 0x60, 0x60, 0x60}, // F
    {0x3C, 0x7E, 0x60, 0x60, 0x66, 0x66, 0x7E, 0x3E}, // G
    {0x66, 0x66, 0x66, 0x7E, 0x7E, 0x66, 0x66, 0x66}, // H
    {0x3C, 0x3C, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x3C}, // I
    {0x06, 0x06, 0x06, 0x06, 0x06, 0x66, 0x7E, 0x3C}, // J
    {0x62, 0x66, 0x6C, 0x78, 0x78, 0x6C, 0x66, 0x62}, // K
    {0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x7E, 0x7E}, // L
    {0x00, 0x81, 0xC3, 0xE7, 0xFF, 0xDB, 0xC3, 0xC3}, // M
    {0x00, 0xC6, 0xE6, 0xF6, 0xDE, 0xCE, 0xC6, 0xC6}, // N
    {0x3C, 0x7E, 0x66, 0x66, 0x66, 0x66, 0x7E, 0x3C}, // O
    {0x7C, 0x7E, 0x66, 0x66, 0x7E, 0x7E, 0x60, 0x60}, // P
    {0x7E, 0x7E, 0x66, 0x66, 0x66, 0x66, 0x7F, 0x7F}, // Q
    {0x00, 0x7E, 0x62, 0x7C, 0x7C, 0x66, 0x66, 0x66}, // R
    {0x3C, 0x7E, 0x60, 0x3C, 0x06, 0x66, 0x7E, 0x3C}, // S
    {0x7E, 0x7E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18}, // T
    {0x00, 0x66, 0x66, 0x66, 0x66, 0x66, 0x7E, 0x7E}, // U
    {0x00, 0x81, 0xC3, 0xC3, 0x66, 0x66, 0x18, 0x18}, // V
    {0x00, 0x81, 0x99, 0x5A, 0x5A, 0x5A, 0x24, 0x24}, // W
    {0x42, 0x66, 0x24, 0x18, 0x18, 0x24, 0x66, 0x42}, // X
    {0xC3, 0x42, 0x66, 0x3C, 0x18, 0x18, 0x18, 0x18}, // Y
    {0x7E, 0x7E, 0x06, 0x0C, 0x18, 0x30, 0x7E, 0x7E}, // Z

    // 小写字母a-z (8x6字体)
    {0x00, 0x00, 0x00, 0x00, 0x3C, 0x24, 0x24, 0x3E}, // a
    {0x00, 0x20, 0x20, 0x20, 0x38, 0x24, 0x24, 0x38}, // b
    {0x00, 0x00, 0x00, 0x00, 0x38, 0x20, 0x20, 0x38}, // c
    {0x00, 0x04, 0x04, 0x04, 0x3C, 0x24, 0x24, 0x3E}, // d
    {0x00, 0x00, 0x00, 0x18, 0x24, 0x38, 0x20, 0x1C}, // e
    {0x00, 0x1C, 0x10, 0x10, 0x3C, 0x10, 0x10, 0x10}, // f
    {0x00, 0x18, 0x24, 0x24, 0x1C, 0x04, 0x24, 0x18}, // g
    {0x00, 0x20, 0x20, 0x20, 0x3C, 0x24, 0x24, 0x24}, // h
    {0x00, 0x00, 0x00, 0x10, 0x00, 0x10, 0x10, 0x10}, // i
    {0x00, 0x04, 0x00, 0x04, 0x04, 0x04, 0x24, 0x18}, // j
    {0x00, 0x20, 0x20, 0x24, 0x28, 0x30, 0x28, 0x24}, // k
    {0x00, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x38}, // l
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x3E, 0x2A, 0x2A}, // m
    {0x00, 0x00, 0x00, 0x00, 0x3C, 0x24, 0x24, 0x24}, // n
    {0x00, 0x00, 0x00, 0x18, 0x24, 0x24, 0x24, 0x18}, // o
    {0x00, 0x3C, 0x24, 0x24, 0x3C, 0x20, 0x20, 0x20}, // p
    {0x00, 0x3C, 0x24, 0x24, 0x3C, 0x04, 0x04, 0x04}, // q
    {0x00, 0x00, 0x00, 0x00, 0x38, 0x20, 0x20, 0x20}, // r
    {0x00, 0x00, 0x00, 0x1C, 0x20, 0x18, 0x04, 0x38}, // s
    {0x00, 0x00, 0x10, 0x10, 0x3C, 0x10, 0x14, 0x08}, // t
    {0x00, 0x00, 0x00, 0x00, 0x24, 0x24, 0x24, 0x3C}, // u
    {0x00, 0x00, 0x00, 0x00, 0x22, 0x14, 0x14, 0x08}, // v
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x2A, 0x2A, 0x3E}, // w
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x28, 0x10, 0x28}, // x
    {0x00, 0x00, 0x24, 0x24, 0x1C, 0x04, 0x24, 0x18}, // y
    {0x00, 0x00, 0x00, 0x00, 0x3C, 0x08, 0x10, 0x3C}, // z

    // 标点符号 (8x6字体)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // 空格
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x0C, 0x00}, // . (句点)
    {0x00, 0x00, 0x00, 0x00, 0x0C, 0x0C, 0x04, 0x08}, // , (逗号)
    {0x00, 0x00, 0x30, 0x30, 0x00, 0x30, 0x30, 0x00}, // : (冒号)
    {0x00, 0x00, 0x30, 0x00, 0x30, 0x30, 0x10, 0x20}, // ; (分号)
    {0x00, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18, 0x00}, // ! (感叹号)
    {0x00, 0x38, 0x44, 0x44, 0x1C, 0x10, 0x00, 0x10}, // ? (问号)
    {0x00, 0x00, 0x00, 0x00, 0x3C, 0x00, 0x00, 0x00}, // - (连字符)
    {0x00, 0x00, 0x30, 0x30, 0x20, 0x00, 0x00, 0x00}, // ' (单引号)
    {0x00, 0x00, 0x36, 0x36, 0x24, 0x00, 0x00, 0x00}  // " (双引号)
};

/**
 * @brief 发送一个字节的数据到HC595移位寄存器
 * @param data 要发送的8位数据
 * @return 无返回值
 *
 * 该函数通过位操作将一个字节的数据逐位发送到HC595移位寄存器中，
 * 使用软件模拟SPI通信协议，先发送最高位(MSB)。
 */
void send_bits(unsigned char data) {
    // 循环发送数据的每一位，从最高位开始
    for(unsigned char i = 0; i < 8; i++) {
        HC595_CLK = 0;
        HC595_DI = (data & 0x80) ? 1 : 0;  // 先发送最高位
        HC595_CLK = 1;
        data <<= 1;
    }
}

/**
 * @brief 显示指定行的LED点阵数据
 * @param row 要显示的行号 (0-7)
 * @param col_data 该行的列数据，8位二进制数表示每个LED的状态
 * @return 无返回值
 *
 * 该函数先锁存HC595寄存器，然后发送行选择数据和列数据，
 * 最后通过上升沿锁存数据并行输出到LED点阵屏。
 */
void display_row(unsigned char row, unsigned char col_data) {
    HC595_LAT = 0;  // 准备锁存
    // 先发送行选择数据(低电平有效)
    send_bits(~(0x01<<row));  // 行选择，某一位为0选中该行
    // 再发送列数据
    send_bits(col_data);
    HC595_LAT = 1;  // 上升沿锁存，数据并行输出
}

/**
 * @brief 在LED点阵屏上显示指定图案
 * @param row_data 包含8行数据的数组，每个元素代表一行的显示数据
 * @return 无返回值
 *
 * 注意：点阵屏采用共阴极接法，数据位为1时表示点亮对应LED
 */
void led_matrix_display(unsigned char row_data[8], unsigned int display_time) {
    if (row_data == NULL) {
        return; // 防止空指针访问
    }
    unsigned int elapsed_time = 0;
    while (elapsed_time < display_time) {
        // 每次显示8行数据
        for(unsigned char row = 0; row < 8; row++) {
            display_row(row, row_data[row]);
            delay_ms(1);  // 延时1ms，确保数据稳定
        }
        elapsed_time += 8; // 每次循环耗时8ms
    }
}

/**
 * @brief 显示图像
 * @param img 指向包含8个字节的图像数据结构
 */
void show_image(const Image *img) {
    if (img == NULL || img->data == NULL) {
        return; // 防止空指针访问
    }
    led_matrix_display((unsigned char*)img->data,200);
}

/**
 * @brief 显示单个点
 * @param x 列索引（0-7）
 * @param y 行索引（0-7）
 */
void show_dot(unsigned char x, unsigned char y) {
    if (x > 7 || y > 7) return;
    unsigned char pattern[8] = {0};
    pattern[y] = 1 << x;
    led_matrix_display(pattern,200); // 显示2秒钟
}

/**
 * @brief 显示水平线条
 * @param y 行索引（0-7）
 */
void show_h_line(unsigned char y) {
    if (y > 7) return;
    unsigned char pattern[8] = {0};
    pattern[y] = 0xFF; // 全1
    led_matrix_display(pattern,200);
}

/**
 * @brief 显示垂直线条
 * @param x 列索引（0-7）
 */
void show_v_line(unsigned char x) {
    if (x > 7) return;
    unsigned char pattern[8] = {0};
    for (unsigned char i = 0; i < 8; i++) {
        pattern[i] = 1 << x;
    }
    led_matrix_display(pattern,200);
}

/**
 * @brief 动画演示心形图案的闪烁效果
 */
void animate_heart(void) {
    show_image(&HEART_SMALL);
    show_image(&HEART);

}

/**
 * @brief 动画演示正方形的逐渐变大和变小
 */
void animate_square(void) {
    // 从小到大显示
    for (int i = 4; i >= 0; i--) {
        led_matrix_display(SQUARE_PATTERNS[i],200);
    }

    // 从大到小显示
    for (int i = 0; i <= 4; i++) {
        led_matrix_display(SQUARE_PATTERNS[i],200);
    }
}

/**
 * @brief 获取字符在字体数组中的索引。
 *
 * 根据字符类型（数字、大写字母、小写字母、标点符号）返回对应的索引。
 * 索引范围为0-71，分别对应0-9, A-Z, a-z, 以及标点符号。
 *
 * @param c 要获取索引的字符
 * @return 字符在FONT_CENTERED数组中的索引
 */
int get_char_index(char c) {
    if (c >= '0' && c <= '9') return c - '0';
    if (c >= 'A' && c <= 'Z') return 10 + (c - 'A');
    if (c >= 'a' && c <= 'z') return 36 + (c - 'a');

    switch(c) {
        case ' ': return 62;
        case '.': return 63;
        case ',': return 64;
        case ':': return 65;
        case ';': return 66;
        case '!': return 67;
        case '?': return 68;
        case '-': return 69;
        case '\'': return 70;
        case '"': return 71;
        default: return 62; // 空格
    }
}

void show_char(char c) {
    int index = get_char_index(c);
    if (index < 0 || index > 71) return; // 超出范围则不显示

    // 获取对应的字体数据
    const unsigned char *font_data = FONT_CENTERED[index];
    unsigned char row_data[8] = {0};

    // 将字体数据转换为行数据
    for (int i = 0; i < 8; i++) {
        row_data[i] = font_data[i];
    }

    // 显示字符
    led_matrix_display(row_data,200);
}

void scroll_text(const char *text, unsigned int ms) {
    int len = 0;
    // 计算字符串长度
    while(text[len] != '\0') len++;

    // 每帧显示一个字符
    for(int pos = 0; pos < len; pos++) {
        show_char(text[pos]);
        delay_ms(ms);
    }
}

#endif // USE_LED_MATRIX_8x8_HC595
