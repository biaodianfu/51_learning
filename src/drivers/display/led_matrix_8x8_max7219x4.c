#include "config.h"
#include <string.h>

#if USE_LED_MATRIX_8x8_MAX7219x4
#include "led_matrix_8x8_max7219x4.h"

unsigned char __code FONT[38][8]={
    {0x3C,0x42,0x42,0x42,0x42,0x42,0x42,0x3C},//0
    {0x10,0x18,0x14,0x10,0x10,0x10,0x10,0x10},//1
    {0x7E,0x2,0x2,0x7E,0x40,0x40,0x40,0x7E},//2
    {0x3E,0x2,0x2,0x3E,0x2,0x2,0x3E,0x0},//3
    {0x8,0x18,0x28,0x48,0xFE,0x8,0x8,0x8},//4
    {0x3C,0x20,0x20,0x3C,0x4,0x4,0x3C,0x0},//5
    {0x3C,0x20,0x20,0x3C,0x24,0x24,0x3C,0x0},//6
    {0x3E,0x22,0x4,0x8,0x8,0x8,0x8,0x8},//7
    {0x0,0x3E,0x22,0x22,0x3E,0x22,0x22,0x3E},//8
    {0x3E,0x22,0x22,0x3E,0x2,0x2,0x2,0x3E},//9
    {0x8,0x14,0x22,0x3E,0x22,0x22,0x22,0x22},//A
    {0x3C,0x22,0x22,0x3E,0x22,0x22,0x3C,0x0},//B
    {0x3C,0x40,0x40,0x40,0x40,0x40,0x3C,0x0},//C
    {0x7C,0x42,0x42,0x42,0x42,0x42,0x7C,0x0},//D
    {0x7C,0x40,0x40,0x7C,0x40,0x40,0x40,0x7C},//E
    {0x7C,0x40,0x40,0x7C,0x40,0x40,0x40,0x40},//F
    {0x3C,0x40,0x40,0x40,0x40,0x44,0x44,0x3C},//G
    {0x44,0x44,0x44,0x7C,0x44,0x44,0x44,0x44},//H
    {0x7C,0x10,0x10,0x10,0x10,0x10,0x10,0x7C},//I
    {0x3C,0x8,0x8,0x8,0x8,0x8,0x48,0x30},//J
    {0x0,0x24,0x28,0x30,0x20,0x30,0x28,0x24},//K
    {0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x7C},//L
    {0x81,0xC3,0xA5,0x99,0x81,0x81,0x81,0x81},//M
    {0x0,0x42,0x62,0x52,0x4A,0x46,0x42,0x0},//N
    {0x3C,0x42,0x42,0x42,0x42,0x42,0x42,0x3C},//O
    {0x3C,0x22,0x22,0x22,0x3C,0x20,0x20,0x20},//P
    {0x1C,0x22,0x22,0x22,0x22,0x26,0x22,0x1D},//Q
    {0x3C,0x22,0x22,0x22,0x3C,0x24,0x22,0x21},//R
    {0x0,0x1E,0x20,0x20,0x3E,0x2,0x2,0x3C},//S
    {0x0,0x3E,0x8,0x8,0x8,0x8,0x8,0x8},//T
    {0x42,0x42,0x42,0x42,0x42,0x42,0x22,0x1C},//U
    {0x42,0x42,0x42,0x42,0x42,0x42,0x24,0x18},//V
    {0x0,0x49,0x49,0x49,0x49,0x2A,0x1C,0x0},//W
    {0x0,0x41,0x22,0x14,0x8,0x14,0x22,0x41},//X
    {0x41,0x22,0x14,0x8,0x8,0x8,0x8,0x8},//Y
    {0x0,0x7F,0x2,0x4,0x8,0x10,0x20,0x7F},//Z
    {0x8,0x7F,0x49,0x49,0x7F,0x8,0x8,0x8},//中
    {0xFE,0xBA,0x92,0xBA,0x92,0x9A,0xBA,0xFE},//国
};

void write_max7219_byte_with_delay(unsigned char data) {
    for (unsigned char i = 0; i < 8; i++) {
        MAX7219_CLK = 0;
        MAX7219_DIN = (data & 0x80) ? 1 : 0;
        data <<= 1;
        // 短延时确保信号稳定
        ASM_NOP(); ASM_NOP(); ASM_NOP();
        ASM_NOP(); ASM_NOP(); ASM_NOP();
        MAX7219_CLK = 1;
        ASM_NOP(); ASM_NOP(); ASM_NOP();
    }
}

/**
 * @brief 向MAX7219写入指定地址的数据。
 *
 * 通过CS片选控制开始和结束通信过程，依次发送地址和数据两个字节。
 *
 * @param addr 寄存器地址
 * @param data 要写入的数据
 */
void max7219_write(unsigned char addr, unsigned char data) {
    MAX7219_CS = 0;
    write_max7219_byte_with_delay(addr);
    write_max7219_byte_with_delay(data);
    MAX7219_CS = 1;
    MAX7219_CLK = 0;
}

/**
 * @brief 初始化MAX7219芯片。
 *
 * 配置MAX7219的工作参数，包括译码模式、亮度、扫描位数、工作模式及显示测试状态。
 */
void max7219_init(void) {
    max7219_write(0x09, 0x00);   // 解码模式：不译码
    max7219_write(0x0A, 0x01);   // 亮度设置（范围0x00-0x0F）
    max7219_write(0x0B, 0x07);   // 扫描位数：8位（0-7）
    max7219_write(0x0C, 0x01);   // 工作模式：正常
    max7219_write(0x0F, 0x00);   // 显示测试：关闭
}

void test_show(void){
    max7219_init(); // 初始化MAX7219芯片
    while(1)
    {
        for(unsigned char i=0;i<38;i++)
        {
            for(unsigned char j=1;j<9;j++)
                max7219_write(j, FONT[i][j-1]);
            delay_ms(1000);
        }
    }
}

#endif  // USE_LED_MATRIX_8X8_MAX7219X4
