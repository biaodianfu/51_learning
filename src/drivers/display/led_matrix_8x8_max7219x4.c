#include "config.h"
#include <string.h>

#if USE_LED_MATRIX_8x8_MAX7219x4
#include "led_matrix_8x8_max7219x4.h"

/**
 * @brief 字体数组，包含数字0-9、字母A-Z和空格的8x8点阵数据
 * 每个字符由8个字节表示，每个字节对应点阵的一行
 */
unsigned char __code font[37][8] = {
    {0x3C,0x42,0x42,0x42,0x42,0x42,0x42,0x3C},//0
    {0x10,0x30,0x50,0x10,0x10,0x10,0x10,0x7C},//1
    {0x3E,0x02,0x02,0x3E,0x20,0x20,0x3E,0x00},//2
    {0x00,0x7C,0x04,0x04,0x7C,0x04,0x04,0x7C},//3
    {0x08,0x18,0x28,0x48,0xFE,0x08,0x08,0x08},//4
    {0x3C,0x20,0x20,0x3C,0x04,0x04,0x3C,0x00},//5
    {0x3C,0x20,0x20,0x3C,0x24,0x24,0x3C,0x00},//6
    {0x3E,0x22,0x04,0x08,0x08,0x08,0x08,0x08},//7
    {0x00,0x3E,0x22,0x22,0x3E,0x22,0x22,0x3E},//8
    {0x3E,0x22,0x22,0x3E,0x02,0x02,0x02,0x3E},//9
    {0x08,0x14,0x22,0x3E,0x22,0x22,0x22,0x22},//A
    {0x3C,0x22,0x22,0x3E,0x22,0x22,0x3C,0x00},//B
    {0x3C,0x40,0x40,0x40,0x40,0x40,0x3C,0x00},//C
    {0x7C,0x42,0x42,0x42,0x42,0x42,0x7C,0x00},//D
    {0x7C,0x40,0x40,0x7C,0x40,0x40,0x40,0x7C},//E
    {0x7C,0x40,0x40,0x7C,0x40,0x40,0x40,0x40},//F
    {0x3C,0x40,0x40,0x40,0x40,0x44,0x44,0x3C},//G
    {0x44,0x44,0x44,0x7C,0x44,0x44,0x44,0x44},//H
    {0x7C,0x10,0x10,0x10,0x10,0x10,0x10,0x7C},//I
    {0x3C,0x08,0x08,0x08,0x08,0x08,0x48,0x30},//J
    {0x00,0x24,0x28,0x30,0x20,0x30,0x28,0x24},//K
    {0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x7C},//L
    {0x81,0xC3,0xA5,0x99,0x81,0x81,0x81,0x81},//M
    {0x00,0x42,0x62,0x52,0x4A,0x46,0x42,0x00},//N
    {0x3C,0x42,0x42,0x42,0x42,0x42,0x42,0x3C},//O
    {0x3C,0x22,0x22,0x22,0x3C,0x20,0x20,0x20},//P
    {0x1C,0x22,0x22,0x22,0x22,0x26,0x22,0x1D},//Q
    {0x3C,0x22,0x22,0x22,0x3C,0x24,0x22,0x21},//R
    {0x00,0x1E,0x20,0x20,0x3E,0x02,0x02,0x3C},//S
    {0x00,0x3E,0x08,0x08,0x08,0x08,0x08,0x08},//T
    {0x42,0x42,0x42,0x42,0x42,0x42,0x22,0x1C},//U
    {0x42,0x42,0x42,0x42,0x42,0x42,0x24,0x18},//V
    {0x00,0x49,0x49,0x49,0x49,0x2A,0x1C,0x00},//W
    {0x00,0x41,0x22,0x14,0x08,0x14,0x22,0x41},//X
    {0x41,0x22,0x14,0x08,0x08,0x08,0x08,0x08},//Y
    {0x00,0x7F,0x02,0x04,0x08,0x10,0x20,0x7F},//Z
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},//space
};

/**
 * @brief 获取字符在字体数组中的索引
 * @param c 输入字符
 * @return 返回字符对应的索引值（0-36），超出范围返回空格索引36
 */
int get_char_index(unsigned char c){
    if (c >= '0' && c <= '9') return c - '0';
    if (c >= 'A' && c <= 'Z') return 10 + (c - 'A');
    if (c == ' ') return 36;
    return 36; // 默认返回空格索引
}

/**
 * @brief 向MAX7219发送一个字节数据
 * @param data 要发送的数据字节
 */
void send_byte(unsigned char data) {
    for(unsigned char i = 0; i < 8; i++) {
        MAX7219_DIN = (data & 0x80) ? 1 : 0;
        MAX7219_CLK = 1;
        delay_us(1);
        MAX7219_CLK = 0;
        data <<= 1;
    }
}

/**
 * @brief 向四个级联的MAX7219芯片写入数据
 * @param addr 寄存器地址
 * @param dat1 第一个芯片的数据
 * @param dat2 第二个芯片的数据
 * @param dat3 第三个芯片的数据
 * @param dat4 第四个芯片的数据
 */
void max7219_write(unsigned char addr,unsigned char dat1,unsigned char dat2, unsigned char dat3,unsigned char dat4)
{
    MAX7219_CS = 0;
    send_byte(addr);
    send_byte(dat1);
    send_byte(dat2);
    send_byte(dat3);
    send_byte(dat4);
    MAX7219_CS = 1;
    MAX7219_CLK = 0;
}

/**
 * @brief 初始化MAX7219芯片
 * 配置解码模式、亮度、扫描位数、工作模式和显示测试
 */
void max7219_init(void) {
    max7219_write(0x09, 0x00,0x00,0x00,0x00);   // 解码模式：不译码
    max7219_write(0x0A, 0x01,0x01,0x01,0x01);   // 亮度设置（范围0x00-0x0F）
    max7219_write(0x0B, 0x07,0x07,0x07,0x07);   // 扫描位数：8位（0-7）
    max7219_write(0x0C, 0x01,0x01,0x01,0x01);   // 工作模式：正常
    max7219_write(0x0F, 0x00,0x00,0x00,0x00);   // 显示测试：关闭
}

/**
 * @brief 在LED矩阵上显示四个字符
 * @param dat1 第一个字符
 * @param dat2 第二个字符
 * @param dat3 第三个字符
 * @param dat4 第四个字符
 */
void led_print(unsigned char dat1,unsigned char dat2, unsigned char dat3,unsigned char dat4) {
    int idx1 = get_char_index(dat1);
    int idx2 = get_char_index(dat2);
    int idx3 = get_char_index(dat3);
    int idx4 = get_char_index(dat4);

    // 逐行发送字符点阵数据到四个MAX7219芯片
    for(unsigned char i = 1; i <= 8; i++) {
        max7219_write(i, font[idx4][i-1], font[idx3][i-1], font[idx2][i-1], font[idx1][i-1]);
    }
}

#endif  // USE_LED_MATRIX_8X8_MAX7219X4

