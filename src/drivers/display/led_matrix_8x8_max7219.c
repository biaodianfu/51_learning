#include <stddef.h>
#include <string.h>
#include "config.h"
#if USE_LED_MATRIX_8x8_MAX7219
#include "led_matrix_8x8_max7219.h"

// Microbit风格图像函数库
const Image HEART = {{0x66, 0xFF, 0xFF, 0xFF, 0x7E, 0x3C, 0x18, 0x00}};
const Image HEART_SMALL = {{0x00, 0x6C, 0xFE, 0x7C, 0x38, 0x10, 0x00, 0x00}};
const Image HAPPY = {{0x3C, 0x42, 0xA5, 0x81, 0xA5, 0x99, 0x42, 0x3C}};
const Image SMILE = {{0x3C, 0x42, 0xA5, 0x81, 0x99, 0x99, 0x42, 0x3C}};
const Image SAD = {{0x3C, 0x42, 0xA5, 0x81, 0xA5, 0x99, 0x5A, 0x3C}};
const Image CONFUSED = {{0x3C, 0x42, 0xA5, 0x89, 0x91, 0x91, 0x42, 0x3C}};
const Image ANGRY = {{0x3C, 0x42, 0xA5, 0x81, 0xBD, 0x81, 0x42, 0x3C}};
const Image ASLEEP = {{0x3C, 0x42, 0x99, 0xA5, 0xA5, 0x99, 0x52, 0x3C}};
const Image SURPRISED = {{0x3C, 0x42, 0xA5, 0x81, 0xA5, 0x99, 0x5A, 0x3C}};
const Image SILLY = {{0x3C, 0x42, 0xA5, 0x81, 0x99, 0x89, 0x52, 0x3C}};
const Image FABULOUS = {{0x7E, 0x91, 0x61, 0x41, 0x61, 0x91, 0x7E, 0x00}};
const Image MEH = {{0x3C, 0x42, 0xA5, 0x81, 0xB9, 0x85, 0x42, 0x3C}};
const Image YES = {{0x00, 0x01, 0x03, 0x46, 0x6C, 0x38, 0x10, 0x00}}; // √
const Image NO = {{0xC3, 0x66, 0x3C, 0x18, 0x18, 0x3C, 0x66, 0xC3}}; // ×

// 箭头方向 (8种)
const Image ARROW_N = {{0x18, 0x3C, 0x7E, 0xFF, 0x18, 0x18, 0x18, 0x18}};
const Image ARROW_NE = {{0x80, 0xC0, 0xE2, 0x76, 0x3E, 0x1C, 0x08, 0x00}};
const Image ARROW_E = {{0x08, 0x0C, 0xFE, 0xFF, 0xFE, 0x0C, 0x08, 0x00}};
const Image ARROW_SE = {{0x00, 0x08, 0x1C, 0x3E, 0x76, 0xE2, 0xC0, 0x80}};
const Image ARROW_S = {{0x18, 0x18, 0x18, 0x18, 0xFF, 0x7E, 0x3C, 0x18}};
const Image ARROW_SW = {{0x02, 0x06, 0x8E, 0xDC, 0xF8, 0x70, 0x20, 0x00}};
const Image ARROW_W = {{0x00, 0x10, 0x30, 0x7F, 0xFF, 0x7F, 0x30, 0x10}};
const Image ARROW_NW = {{0x00, 0x20, 0x70, 0xF8, 0xDC, 0x8E, 0x06, 0x02}};

// 几何形状
const Image TRIANGLE = {{0x80, 0xC0, 0xE0, 0xF0, 0xE0, 0xC0, 0x80, 0x00}};
const Image TRIANGLE_LEFT = {{0x00, 0x08, 0x0C, 0xFE, 0xFF, 0x0C, 0x08, 0x00}};
const Image CHESSBOARD = {{0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55}};
const Image DIAMOND = {{0x18, 0x3C, 0x7E, 0xFF, 0xFF, 0x7E, 0x3C, 0x18}};
const Image DIAMOND_SMALL = {{0x00, 0x18, 0x3C, 0x7E, 0x7E, 0x3C, 0x18, 0x00}};
const Image SQUARE = {{0xFF, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0xFF}};
const Image SQUARE_SMALL = {{0x00, 0x3C, 0x24, 0x24, 0x24, 0x24, 0x3C, 0x00}};

// 动物和生物
const Image RABBIT = {{0x30, 0x5D, 0xDF, 0x5C, 0x30, 0x28, 0x34, 0x18}};
const Image COW = {{0x87, 0xC7, 0x7E, 0x38, 0x3C, 0x66, 0x43, 0x01}};
const Image DUCK = {{0x00, 0x0C, 0x1F, 0x1F, 0x1C, 0x7E, 0x4C, 0x00}};
const Image TORTOISE = {{0x18, 0x7E, 0xFF, 0x5A, 0x5A, 0x7E, 0x18, 0x00}};
const Image BUTTERFLY ={{0x99, 0x5A, 0x3C, 0xFF, 0xFF, 0x3C, 0x5A, 0x99}};
const Image STICKFIGURE = {{0x18, 0x18, 0x18, 0x3C, 0x99, 0x42, 0x24, 0x18}};
const Image GHOST = {{0x7E, 0xFF, 0xC3, 0xDB, 0xDB, 0xDB, 0xE7, 0x66}};
const Image GIRAFFE = {{0x30, 0x30, 0x38, 0x7C, 0xE6, 0x0F, 0x19, 0x18}};
const Image SKULL = {{0x3C, 0x7E, 0xC3, 0xDB, 0xC3, 0xDB, 0x7E, 0x3C}};
const Image SNAKE = {{0x00, 0x00, 0x76, 0xDF, 0xDB, 0x76, 0x00, 0x00}};

// 物品
const Image MUSIC_CROTCHET = {{0x0C, 0x0C, 0x0C, 0x0C, 0x38, 0x60, 0x7E, 0x3C}};
const Image MUSIC_QUAVER = {{0x18, 0x18, 0x18, 0x18, 0x70, 0xC0, 0xFE, 0x7C}};
const Image MUSIC_QUAVERS = {{0x66, 0x66, 0x66, 0x66, 0xE6, 0x06, 0xFC, 0xF8}};
const Image PITCHFORK = {{0x28, 0x28, 0x28, 0xEF, 0x28, 0x28, 0x28, 0x28}};
const Image XMAS = {{0x18, 0x3C, 0x7E, 0xFF, 0x5A, 0x5A, 0x24, 0x24}};
const Image PACMAN = {{0x3C, 0x7E, 0xF3, 0xE1, 0xE1, 0xF3, 0x7E, 0x3C}};
const Image TARGET = {{0x3C, 0x42, 0x99, 0xA5, 0xA5, 0x99, 0x42, 0x3C}};
const Image TSHIRT = {{0x44, 0xEE, 0xFE, 0xFE, 0x7C, 0x38, 0x38, 0x38}};
const Image ROLLERSKATE = {{0x00, 0x5A, 0xBD, 0xBD, 0x99, 0xFF, 0x66, 0x00}};
const Image HOUSE = {{0x18, 0x3C, 0x7E, 0xDB, 0xFF, 0xDB, 0xC3, 0xC3}};
const Image SWORD = {{0x18, 0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0x18}};
const Image UMBRELLA = {{0x3C, 0x42, 0x99, 0xA1, 0x99, 0x89, 0x46, 0x3C}};
const Image SCISSORS = {{0x21, 0x73, 0x3F, 0x1E, 0x1E, 0x3F, 0x73, 0x21}};

// 预定义正方形动画图形
const __code unsigned char SQUARE_PATTERNS[5][8] = {
    {0xFF,0x81,0x81,0x81,0x81,0x81,0x81,0xFF}, //8x8正方形
    {0x00,0x7E,0x42,0x42,0x42,0x42,0x7E,0x00}, //6x6正方形
    {0x00,0x00,0x3C,0x24,0x24,0x3C,0x00,0x00}, //4x4正方形
    {0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00}, //2x2正方形
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00} //0x0正方形
};

// 重新设计字体数据，确保字符在8x8矩阵中居中显示
const __code unsigned char FONT_CENTERED[][8] = {
    // 0-9 (8x6字体，居中放置在8x8矩阵中)
    {0x00, 0x3C, 0x24, 0x24, 0x24, 0x24, 0x24, 0x3C}, // 0
    {0x00, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04}, // 1
    {0x00, 0x3C, 0x04, 0x04, 0x3C, 0x20, 0x20, 0x3C}, // 2
    {0x00, 0x3C, 0x04, 0x04, 0x3C, 0x04, 0x04, 0x3C}, // 3
    {0x00, 0x24, 0x24, 0x24, 0x3C, 0x04, 0x04, 0x04}, // 4
    {0x00, 0x3C, 0x20, 0x20, 0x3C, 0x04, 0x04, 0x3C}, // 5
    {0x00, 0x3C, 0x20, 0x20, 0x3C, 0x24, 0x24, 0x3C}, // 6 错误
    {0x00, 0x3C, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04}, // 7
    {0x00, 0x3C, 0x24, 0x24, 0x3C, 0x24, 0x24, 0x3C}, // 8
    {0x00, 0x3C, 0x24, 0x24, 0x3C, 0x04, 0x04, 0x04}, // 9

    // 大写字母A-Z (8x6字体)
    {0x18, 0x3C, 0x7E, 0x66, 0x7E, 0x7E, 0x66, 0x66}, // A
    {0x7C, 0x7E, 0x66, 0x7E, 0x7E, 0x66, 0x7E, 0x7C}, // B
    {0x3C, 0x7E, 0x60, 0x60, 0x60, 0x60, 0x7E, 0x3C}, // C
    {0x78, 0x7C, 0x66, 0x66, 0x66, 0x66, 0x7C, 0x78}, // D
    {0x7E, 0x7E, 0x60, 0x7C, 0x7C, 0x60, 0x7E, 0x7E}, // E
    {0x7E, 0x7E, 0x60, 0x7C, 0x7C, 0x60, 0x60, 0x60}, // F
    {0x3C, 0x7E, 0x60, 0x60, 0x66, 0x66, 0x7E, 0x3E}, // G
    {0x66, 0x66, 0x66, 0x7E, 0x7E, 0x66, 0x66, 0x66}, // H
    {0x3C, 0x3C, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x3C}, // I
    {0x06, 0x06, 0x06, 0x06, 0x06, 0x66, 0x7E, 0x3C}, // J
    {0x62, 0x66, 0x6C, 0x78, 0x78, 0x6C, 0x66, 0x62}, // K
    {0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x7E, 0x7E}, // L
    {0x00, 0x81, 0xC3, 0xE7, 0xFF, 0xDB, 0xC3, 0xC3}, // M
    {0x00, 0xC6, 0xE6, 0xF6, 0xDE, 0xCE, 0xC6, 0xC6}, // N
    {0x3C, 0x7E, 0x66, 0x66, 0x66, 0x66, 0x7E, 0x3C}, // O
    {0x7C, 0x7E, 0x66, 0x66, 0x7E, 0x7E, 0x60, 0x60}, // P
    {0x7E, 0x7E, 0x66, 0x66, 0x66, 0x66, 0x7F, 0x7F}, // Q
    {0x00, 0x7E, 0x62, 0x7C, 0x7C, 0x66, 0x66, 0x66}, // R
    {0x3C, 0x7E, 0x60, 0x3C, 0x06, 0x66, 0x7E, 0x3C}, // S
    {0x7E, 0x7E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18}, // T
    {0x00, 0x66, 0x66, 0x66, 0x66, 0x66, 0x7E, 0x7E}, // U
    {0x00, 0x81, 0xC3, 0xC3, 0x66, 0x66, 0x18, 0x18}, // V
    {0x00, 0x81, 0x99, 0x5A, 0x5A, 0x5A, 0x24, 0x24}, // W
    {0x42, 0x66, 0x24, 0x18, 0x18, 0x24, 0x66, 0x42}, // X
    {0xC3, 0x42, 0x66, 0x3C, 0x18, 0x18, 0x18, 0x18}, // Y
    {0x7E, 0x7E, 0x06, 0x0C, 0x18, 0x30, 0x7E, 0x7E}, // Z

    // 小写字母a-z (8x6字体)
    {0x00, 0x00, 0x00, 0x00, 0x3C, 0x24, 0x24, 0x3E}, // a
    {0x00, 0x20, 0x20, 0x20, 0x38, 0x24, 0x24, 0x38}, // b
    {0x00, 0x00, 0x00, 0x00, 0x38, 0x20, 0x20, 0x38}, // c
    {0x00, 0x04, 0x04, 0x04, 0x3C, 0x24, 0x24, 0x3E}, // d
    {0x00, 0x00, 0x00, 0x18, 0x24, 0x38, 0x20, 0x1C}, // e
    {0x00, 0x1C, 0x10, 0x10, 0x3C, 0x10, 0x10, 0x10}, // f
    {0x00, 0x18, 0x24, 0x24, 0x1C, 0x04, 0x24, 0x18}, // g
    {0x00, 0x20, 0x20, 0x20, 0x3C, 0x24, 0x24, 0x24}, // h
    {0x00, 0x00, 0x00, 0x10, 0x00, 0x10, 0x10, 0x10}, // i
    {0x00, 0x04, 0x00, 0x04, 0x04, 0x04, 0x24, 0x18}, // j
    {0x00, 0x20, 0x20, 0x24, 0x28, 0x30, 0x28, 0x24}, // k
    {0x00, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x38}, // l
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x3E, 0x2A, 0x2A}, // m
    {0x00, 0x00, 0x00, 0x00, 0x3C, 0x24, 0x24, 0x24}, // n
    {0x00, 0x00, 0x00, 0x18, 0x24, 0x24, 0x24, 0x18}, // o
    {0x00, 0x3C, 0x24, 0x24, 0x3C, 0x20, 0x20, 0x20}, // p
    {0x00, 0x3C, 0x24, 0x24, 0x3C, 0x04, 0x04, 0x04}, // q
    {0x00, 0x00, 0x00, 0x00, 0x38, 0x20, 0x20, 0x20}, // r
    {0x00, 0x00, 0x00, 0x1C, 0x20, 0x18, 0x04, 0x38}, // s
    {0x00, 0x00, 0x10, 0x10, 0x3C, 0x10, 0x14, 0x08}, // t
    {0x00, 0x00, 0x00, 0x00, 0x24, 0x24, 0x24, 0x3C}, // u
    {0x00, 0x00, 0x00, 0x00, 0x22, 0x14, 0x14, 0x08}, // v
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x2A, 0x2A, 0x3E}, // w
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x28, 0x10, 0x28}, // x
    {0x00, 0x00, 0x24, 0x24, 0x1C, 0x04, 0x24, 0x18}, // y
    {0x00, 0x00, 0x00, 0x00, 0x3C, 0x08, 0x10, 0x3C}, // z

    // 标点符号 (8x6字体)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // 空格
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x0C, 0x00}, // . (句点)
    {0x00, 0x00, 0x00, 0x00, 0x0C, 0x0C, 0x04, 0x08}, // , (逗号)
    {0x00, 0x00, 0x30, 0x30, 0x00, 0x30, 0x30, 0x00}, // : (冒号)
    {0x00, 0x00, 0x30, 0x00, 0x30, 0x30, 0x10, 0x20}, // ; (分号)
    {0x00, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18, 0x00}, // ! (感叹号)
    {0x00, 0x38, 0x44, 0x44, 0x1C, 0x10, 0x00, 0x10}, // ? (问号)
    {0x00, 0x00, 0x00, 0x00, 0x3C, 0x00, 0x00, 0x00}, // - (连字符)
    {0x00, 0x00, 0x30, 0x30, 0x20, 0x00, 0x00, 0x00}, // ' (单引号)
    {0x00, 0x00, 0x36, 0x36, 0x24, 0x00, 0x00, 0x00}  // " (双引号)
};

/**
 * @brief 向MAX7219发送一个字节数据，带延时以确保信号稳定。
 *
 * 该函数通过软件模拟SPI方式逐位发送数据。在每个时钟周期中，
 * 先拉低时钟线，设置数据线，插入短延时后拉高时钟线完成一位传输。
 *
 * @param data 要发送的字节数据
 */
void write_max7219_byte_with_delay(unsigned char data) {
    for (unsigned char i = 0; i < 8; i++) {
        MAX7219_CLK = 0;
        MAX7219_DIN = (data & 0x80) ? 1 : 0;
        data <<= 1;

        // 短延时确保信号稳定
        ASM_NOP(); ASM_NOP(); ASM_NOP();
        ASM_NOP(); ASM_NOP(); ASM_NOP();

        MAX7219_CLK = 1;
        ASM_NOP(); ASM_NOP(); ASM_NOP();
    }
}

/**
 * @brief 向MAX7219写入指定地址的数据。
 *
 * 通过CS片选控制开始和结束通信过程，依次发送地址和数据两个字节。
 *
 * @param addr 寄存器地址
 * @param data 要写入的数据
 */
void max7219_write(unsigned char addr, unsigned char data) {
    MAX7219_CS = 0;
    write_max7219_byte_with_delay(addr);
    write_max7219_byte_with_delay(data);
    MAX7219_CS = 1;
    MAX7219_CLK = 0;
}

/**
 * @brief 初始化MAX7219芯片。
 *
 * 配置MAX7219的工作参数，包括译码模式、亮度、扫描位数、工作模式及显示测试状态。
 */
void max7219_init(void) {
    max7219_write(0x09, 0x00);   // 解码模式：不译码
    max7219_write(0x0A, 0x01);   // 亮度设置（范围0x00-0x0F）
    max7219_write(0x0B, 0x07);   // 扫描位数：8位（0-7）
    max7219_write(0x0C, 0x01);   // 工作模式：正常
    max7219_write(0x0F, 0x00);   // 显示测试：关闭
}

/* * @brief 显示图像。
 *
 * 将给定的图像数据写入MAX7219驱动的LED矩阵上。
 * 图像数据应包含8个字节，每个字节代表一行的点亮状态。
 *
 * @param img 指向包含8个字节的图像数据结构
 */
void show_image(const Image *img) {
    for(int i=0; i<8; i++) {
        max7219_write(i+1, img->data[i]);
    }
}

/* * @brief 显示8x8矩阵图案。
 *
 * 将给定的8x8矩阵图案显示在MAX7219驱动的LED矩阵上。
 * 每个字节代表一行，从上到下依次写入。
 *
 * @param pattern 指向包含8个字节的图案数组，每个字节表示一行的点亮状态
 */
void display_matrix(unsigned char *pattern) {
    if (pattern == NULL) {
        return; // 防止空指针访问
    }

    for (unsigned char i = 0; i < 8; i++) {
        max7219_write(i + 1, pattern[i]); // 行地址从1开始（DIG0对应地址0x01）
    }
}

/**
 * @brief 显示单个点。
 *
 * 在8x8矩阵中显示一个点，指定位置(x, y)点亮。
 * 例如，show_dot(0, 0)会点亮左上角的点。
 *
 * @param x 列索引（0-7）
 * @param y 行索引（0-7）
 */
void show_dot(unsigned char x, unsigned char y) {
    if (x > 7 || y > 7) return;
    unsigned char pattern[8] = {0};
    pattern[y] = 1 << (7-x);
    display_matrix(pattern);
}

/**
 * @brief 显示水平线条。
 *
 * 在8x8矩阵中显示一条水平线条，指定行y点亮。
 * 例如，show_h_line(0)会点亮第一行。
 *
 * @param y 行索引（0-7）
 */
void show_h_line(unsigned char y) {
    if (y > 7) return;
    unsigned char pattern[8] = {0xFF}; // 全1
    pattern[y] = 0x00; // 清除y行
    display_matrix(pattern);
}

/**
 * @brief 显示垂直线条。
 *
 * 在8x8矩阵中显示一条垂直线条，指定列x点亮。
 * 例如，show_v_line(0)会点亮第一列。
 *
 * @param x 列索引（0-7）
 */
void show_v_line(unsigned char x) {
    if (x > 7) return; // 参数合法性检查
    unsigned char pattern[8] = {0};
    for (unsigned char i = 0; i < 8; i++) {
        pattern[i] = 1 << (7-x); // 设置x列为1
    }
    display_matrix(pattern);
}

/**
 * @brief 动画演示心形图案的闪烁效果。
 *
 * 先显示小心形图案，然后延时300毫秒，再显示大心形图案，最后再次延时300毫秒。
 */
void animate_heart(void) {
    show_image(&HEART_SMALL);
    delay_ms(300);
    show_image(&HEART);
    delay_ms(300);
}

/**
 * @brief 动画演示8x8矩阵的点亮效果。
 *
 * 逐行点亮8x8矩阵的每个位置，形成一个动态的点亮效果。
 * 每个点亮位置持续100毫秒，然后移动到下一个位置。
 */
void animate_matrix(void) {
    unsigned char pattern[8] = {0};
    for (unsigned char i = 0; i < 8; i++) {
        for (unsigned char j = 0; j < 8; j++) {
            memset(pattern, 0, sizeof(pattern)); // 清空模式
            pattern[i] |= (1 << (7-j)); // 设置点亮位置
            display_matrix(pattern);
            delay_ms(100); // 延时100毫秒
        }
    }
}

/**
 * @brief 动画演示正方形的逐渐变大和变小。
 *
 * 通过预定义的正方形图案数组，逐个显示不同大小的正方形。
 * 每个正方形显示300毫秒，然后切换到下一个大小。
 */
void animate_square(void) {
    // 从小到大显示
    for (int i = 4; i >= 0; i--) {
        display_matrix((unsigned char*)SQUARE_PATTERNS[i]);
        delay_ms(300);
    }

    // 从大到小显示
    for (int i = 1; i <= 4; i++) {
        display_matrix((unsigned char*)SQUARE_PATTERNS[i]);
        delay_ms(300);
    }
}

/**
 * @brief 获取字符在字体数组中的索引。
 *
 * 根据字符类型（数字、大写字母、小写字母、标点符号）返回对应的索引。
 * 索引范围为0-71，分别对应0-9, A-Z, a-z, 以及标点符号。
 *
 * @param c 要获取索引的字符
 * @return 字符在FONT_CENTERED数组中的索引
 */
int get_char_index(unsigned char c) {
    if (c >= '0' && c <= '9') return c - '0';
    if (c >= 'A' && c <= 'Z') return 10 + (c - 'A');
    if (c >= 'a' && c <= 'z') return 36 + (c - 'a');

    switch(c) {
        case ' ': return 62;
        case '.': return 63;
        case ',': return 64;
        case ':': return 65;
        case ';': return 66;
        case '!': return 67;
        case '?': return 68;
        case '-': return 69;
        case '\'': return 70;
        case '"': return 71;
        default: return 62; // 空格
    }
}

/**
 * @brief 显示单个字符。
 *
 * 根据字符获取对应的字体数据，并将其显示在8x8矩阵上。
 * 使用居中字体数据确保字符在矩阵中居中显示。
 *
 * @param c 要显示的字符
 */
void show_char(char c) {
    int idx = get_char_index(c);
    unsigned char pattern[8] = {0};

    // 直接复制居中字体数据
    for(int i = 0; i < 8; i++) {
        pattern[i] = FONT_CENTERED[idx][i];
    }
    display_matrix(pattern);
}

/**
 * @brief 滚动显示文本。
 *
 * 逐个字符显示文本内容，每个字符之间有间隔。
 * 使用居中字体数据确保字符在8x8矩阵中居中显示。
 *
 * @param text 要滚动显示的文本
 * @param ms 每个字符显示的时间（毫秒）
 */
void scroll_text(const char *text, unsigned int ms) {
    int len = strlen(text);
    unsigned char pattern[8] = {0};

    // 每帧显示一个字符
    for(int pos = 0; pos < len; pos++) {
        int idx = get_char_index(text[pos]);

        // 创建字符图案(使用居中字体数据)
        for(int i = 0; i < 8; i++) {
            pattern[i] = FONT_CENTERED[idx][i];
        }

        // 显示当前字符
        display_matrix(pattern);
        delay_ms(ms);

        // 添加字符间空格
        if(pos < len - 1) {
            memset(pattern, 0, 8);
            display_matrix(pattern);
            delay_ms(ms/3);
        }
    }
}
#endif