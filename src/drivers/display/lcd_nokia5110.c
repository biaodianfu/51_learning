#include "config.h"

#if USE_NOKIA_5110_LCD

#include "lcd_nokia5110.h"

unsigned char __code FONT_ASCII[][6] = {
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // sp
        {0x00, 0x00, 0x00, 0x2f, 0x00, 0x00}, // !
        {0x00, 0x00, 0x07, 0x00, 0x07, 0x00}, // "
        {0x00, 0x14, 0x7f, 0x14, 0x7f, 0x14}, // #
        {0x00, 0x24, 0x2a, 0x7f, 0x2a, 0x12}, // $
        {0x00, 0x62, 0x64, 0x08, 0x13, 0x23}, // %
        {0x00, 0x36, 0x49, 0x55, 0x22, 0x50}, // &
        {0x00, 0x00, 0x05, 0x03, 0x00, 0x00}, // '
        {0x00, 0x00, 0x1c, 0x22, 0x41, 0x00}, // (
        {0x00, 0x00, 0x41, 0x22, 0x1c, 0x00}, // )
        {0x00, 0x14, 0x08, 0x3E, 0x08, 0x14}, // *
        {0x00, 0x08, 0x08, 0x3E, 0x08, 0x08}, // +
        {0x00, 0x00, 0x00, 0xA0, 0x60, 0x00}, // ,
        {0x00, 0x08, 0x08, 0x08, 0x08, 0x08}, // -
        {0x00, 0x00, 0x60, 0x60, 0x00, 0x00}, // .
        {0x00, 0x20, 0x10, 0x08, 0x04, 0x02}, // /
        {0x00, 0x3E, 0x51, 0x49, 0x45, 0x3E}, // 0
        {0x00, 0x00, 0x42, 0x7F, 0x40, 0x00}, // 1
        {0x00, 0x42, 0x61, 0x51, 0x49, 0x46}, // 2
        {0x00, 0x21, 0x41, 0x45, 0x4B, 0x31}, // 3
        {0x00, 0x18, 0x14, 0x12, 0x7F, 0x10}, // 4
        {0x00, 0x27, 0x45, 0x45, 0x45, 0x39}, // 5
        {0x00, 0x3C, 0x4A, 0x49, 0x49, 0x30}, // 6
        {0x00, 0x01, 0x71, 0x09, 0x05, 0x03}, // 7
        {0x00, 0x36, 0x49, 0x49, 0x49, 0x36}, // 8
        {0x00, 0x06, 0x49, 0x49, 0x29, 0x1E}, // 9
        {0x00, 0x00, 0x36, 0x36, 0x00, 0x00}, // :
        {0x00, 0x00, 0x56, 0x36, 0x00, 0x00}, // ;
        {0x00, 0x08, 0x14, 0x22, 0x41, 0x00}, // <
        {0x00, 0x14, 0x14, 0x14, 0x14, 0x14}, // =
        {0x00, 0x00, 0x41, 0x22, 0x14, 0x08}, // >
        {0x00, 0x02, 0x01, 0x51, 0x09, 0x06}, // ?
        {0x00, 0x32, 0x49, 0x59, 0x51, 0x3E}, // @
        {0x00, 0x7C, 0x12, 0x11, 0x12, 0x7C}, // A
        {0x00, 0x7F, 0x49, 0x49, 0x49, 0x36}, // B
        {0x00, 0x3E, 0x41, 0x41, 0x41, 0x22}, // C
        {0x00, 0x7F, 0x41, 0x41, 0x22, 0x1C}, // D
        {0x00, 0x7F, 0x49, 0x49, 0x49, 0x41}, // E
        {0x00, 0x7F, 0x09, 0x09, 0x09, 0x01}, // F
        {0x00, 0x3E, 0x41, 0x49, 0x49, 0x7A}, // G
        {0x00, 0x7F, 0x08, 0x08, 0x08, 0x7F}, // H
        {0x00, 0x00, 0x41, 0x7F, 0x41, 0x00}, // I
        {0x00, 0x20, 0x40, 0x41, 0x3F, 0x01}, // J
        {0x00, 0x7F, 0x08, 0x14, 0x22, 0x41}, // K
        {0x00, 0x7F, 0x40, 0x40, 0x40, 0x40}, // L
        {0x00, 0x7F, 0x02, 0x0C, 0x02, 0x7F}, // M
        {0x00, 0x7F, 0x04, 0x08, 0x10, 0x7F}, // N
        {0x00, 0x3E, 0x41, 0x41, 0x41, 0x3E}, // O
        {0x00, 0x7F, 0x09, 0x09, 0x09, 0x06}, // P
        {0x00, 0x3E, 0x41, 0x51, 0x21, 0x5E}, // Q
        {0x00, 0x7F, 0x09, 0x19, 0x29, 0x46}, // R
        {0x00, 0x46, 0x49, 0x49, 0x49, 0x31}, // S
        {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01}, // T
        {0x00, 0x3F, 0x40, 0x40, 0x40, 0x3F}, // U
        {0x00, 0x1F, 0x20, 0x40, 0x20, 0x1F}, // V
        {0x00, 0x3F, 0x40, 0x38, 0x40, 0x3F}, // W
        {0x00, 0x63, 0x14, 0x08, 0x14, 0x63}, // X
        {0x00, 0x07, 0x08, 0x70, 0x08, 0x07}, // Y
        {0x00, 0x61, 0x51, 0x49, 0x45, 0x43}, // Z
        {0x00, 0x00, 0x7F, 0x41, 0x41, 0x00}, // [
        {0x00, 0x55, 0x2A, 0x55, 0x2A, 0x55}, // 55
        {0x00, 0x00, 0x41, 0x41, 0x7F, 0x00}, // ]
        {0x00, 0x04, 0x02, 0x01, 0x02, 0x04}, // ^
        {0x00, 0x40, 0x40, 0x40, 0x40, 0x40}, // _
        {0x00, 0x00, 0x01, 0x02, 0x04, 0x00}, // '
        {0x00, 0x20, 0x54, 0x54, 0x54, 0x78}, // a
        {0x00, 0x7F, 0x48, 0x44, 0x44, 0x38}, // b
        {0x00, 0x38, 0x44, 0x44, 0x44, 0x20}, // c
        {0x00, 0x38, 0x44, 0x44, 0x48, 0x7F}, // d
        {0x00, 0x38, 0x54, 0x54, 0x54, 0x18}, // e
        {0x00, 0x08, 0x7E, 0x09, 0x01, 0x02}, // f
        {0x00, 0x18, 0xA4, 0xA4, 0xA4, 0x7C}, // g
        {0x00, 0x7F, 0x08, 0x04, 0x04, 0x78}, // h
        {0x00, 0x00, 0x44, 0x7D, 0x40, 0x00}, // i
        {0x00, 0x40, 0x80, 0x84, 0x7D, 0x00}, // j
        {0x00, 0x7F, 0x10, 0x28, 0x44, 0x00}, // k
        {0x00, 0x00, 0x41, 0x7F, 0x40, 0x00}, // l
        {0x00, 0x7C, 0x04, 0x18, 0x04, 0x78}, // m
        {0x00, 0x7C, 0x08, 0x04, 0x04, 0x78}, // n
        {0x00, 0x38, 0x44, 0x44, 0x44, 0x38}, // o
        {0x00, 0xFC, 0x24, 0x24, 0x24, 0x18}, // p
        {0x00, 0x18, 0x24, 0x24, 0x18, 0xFC}, // q
        {0x00, 0x7C, 0x08, 0x04, 0x04, 0x08}, // r
        {0x00, 0x48, 0x54, 0x54, 0x54, 0x20}, // s
        {0x00, 0x04, 0x3F, 0x44, 0x40, 0x20}, // t
        {0x00, 0x3C, 0x40, 0x40, 0x20, 0x7C}, // u
        {0x00, 0x1C, 0x20, 0x40, 0x20, 0x1C}, // v
        {0x00, 0x3C, 0x40, 0x30, 0x40, 0x3C}, // w
        {0x00, 0x44, 0x28, 0x10, 0x28, 0x44}, // x
        {0x00, 0x1C, 0xA0, 0xA0, 0xA0, 0x7C}, // y
        {0x00, 0x44, 0x64, 0x54, 0x4C, 0x44}, // z
        {0x14, 0x14, 0x14, 0x14, 0x14, 0x14}  // horiz lines
};

unsigned char __code FONT_GBK[][24] = {
        {0x04, 0x04, 0x04, 0x6F, 0x84, 0x04, 0x84, 0x6F, 0x04, 0x04, 0x04, 0x00, 0x08, 0x08, 0x04, 0x04, 0x02, 0x01,
         0x02, 0x04, 0x04, 0x08, 0x08, 0x00},
        {0x10, 0x12, 0x14, 0x98, 0x50, 0xFF, 0x50, 0x98, 0x14, 0x12, 0x10, 0x00, 0x02, 0x02, 0x01, 0x00, 0x00, 0x0F,
         0x00, 0x00, 0x01, 0x02, 0x02, 0x00},
        {0xFC, 0x24, 0x24, 0x24, 0xFF, 0x24, 0x24, 0x24, 0xFC, 0x00, 0x00, 0x00, 0x03, 0x01, 0x01, 0x01, 0x07, 0x09,
         0x09, 0x09, 0x09, 0x08, 0x0E, 0x00},
        {0x40, 0x40, 0x42, 0x42, 0x42, 0xF2, 0x4A, 0x46, 0x42, 0x40, 0x40, 0x00, 0x00, 0x00, 0x00, 0x08, 0x08, 0x0F,
         0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
};

void lcd_init(void) {
    LCD_RST = 0;
    delay_us(1);
    LCD_RST = 1;
    // 关闭LCD
    LCD_CE = 0;
    delay_us(1);
    // 使能LCD
    LCD_CE = 1;
    delay_us(1);

    lcd_write_byte(0x21, 0);    // 使用扩展命令设置LCD模式
    lcd_write_byte(0xBE, 0);    // 设置偏置电压  /*5110接5V时偏置电压改为（0xBE,0）,接3.3V时改为（0xc0,0）*/
    lcd_write_byte(0x06, 0);    // 温度校正
    lcd_write_byte(0x13, 0);    // 1:48
    lcd_write_byte(0x20, 0);    // 使用基本命令
    lcd_clear();            // 清屏
    lcd_write_byte(0x0C, 0);    // 设定显示模式，正常显示
    // 关闭LCD
    LCD_CE = 0;
}

void lcd_write_byte(unsigned char dat, unsigned char cmd) {
    LCD_CE = 0;
    LCD_DC = (cmd == 0) ? 0 : 1;
    for (unsigned char i = 0; i < 8; i++) {
        SDIN = (dat & 0x80) ? 1 : 0;
        SCLK = 0;
        dat = dat << 1;
        SCLK = 1;
    }
    LCD_CE = 1;
}

void lcd_set_cursor(unsigned char x, unsigned char y) {
    lcd_write_byte(0x80 | x, 0);
    lcd_write_byte(0x40 | y, 0);
}

void lcd_clear(void) {
    lcd_set_cursor(0, 0);
    for (unsigned char row = 0; row < LCD_WIDTH; row++)
        for (unsigned char col = 0; col < LCD_ROW; col++)
            lcd_write_byte(0x00, 1);
}

void lcd_write_char(unsigned char ch) {
    ch -= 32;
    for (unsigned char line = 0; line < LCD_ROW; line++) {
        lcd_write_byte(FONT_ASCII[ch][line], 1);
    }
}

void lcd_write_string(unsigned char x, unsigned char y, char *str) {
    lcd_set_cursor(x, y);
    while (*str)
        lcd_write_char(*str++);
}

void lcd_write_number(unsigned char x, unsigned char y, unsigned int num) {
    unsigned char str[8];
    unsigned char i = 0;

    // 处理特殊情况：num = 0
    if (num == 0) {
        str[0] = '0';
        str[1] = '\0';
        lcd_write_string(x, y, (char *) str);
        return;
    }

    // 从个位开始提取数字字符
    unsigned int temp = num;
    while (temp && i < 7) {  // 保留一个字符用于结束符
        str[i++] = (temp % 10) + '0';
        temp /= 10;
    }

    // 添加字符串结束符
    str[i] = '\0';

    // 反转字符串
    unsigned char len = i;
    for (unsigned char j = 0; j < len / 2; j++) {
        unsigned char temp_char = str[j];
        str[j] = str[len - 1 - j];
        str[len - 1 - j] = temp_char;
    }

    lcd_write_string(x, y, (char *) str);
}

void lcd_write_chinese_string(unsigned char x, unsigned char y, unsigned char ch_width, unsigned char num,
                              unsigned char line, unsigned char line_space) {
    lcd_set_cursor(x, y);
    for (unsigned char i = 0; i < num;)//写第i个汉字
    {
        for (unsigned char n = 0; n < ch_width * 2; n++)  //n代表数组中的第n个数值，ch_with是汉字点阵的宽度，
            //程序定义的是12*12的，但是数组中有24个数值，前面12个为上半部，后面的为下半部
        { //这是因为5110的扫描方式是采用列行似的
            if (n == ch_width)  //在调用此函数时可知ch_with=12；在这里n==ch_with说明第i个汉字上半部分是否已经写完
            {
                if (i == 0)    //如果它还是第一个字的话，列地址（x）不变，行地址（Y）+1，
                    lcd_set_cursor(x, y + 1);//调到第二行写下半部分
                else   //如果不为0，说明前面已经写有字符了，那么列地址x就要加上（字的宽度+字符之间的间隔）*i个字
                    lcd_set_cursor((x + (ch_width + line_space) * i), y + 1);//来转到下一个字的起始列地址，，Y+1即跳到下一行写字的下半部分
            }
            lcd_write_byte(FONT_GBK[line + i][n], 1); //这里的1为写数据，写write_chinese[line+i][n]里的数据。
        }  //write_chinese是2维数组，所以line的值表示选择写数组中的哪个字，+i就接着写下一个，那就是一个字的第即个字节
        i++;
        lcd_set_cursor((x + (ch_width + line_space) * i), y);//列地址x跳到下一个字符的起始位置，行地址y回到字符上半部分的起始地址
    }
}

void
lcd_drwa_bmp_pixel(unsigned char x, unsigned char y, unsigned char width, unsigned char height, unsigned char *map) {
    unsigned int i, n;
    unsigned char row;
    //计算位图所占行数
    if (height % 8 == 0)        //如果为位图所占行数为整数
        row = height / 8;
    else
        row = height / 8 + 1;        //如果为位图所占行数不是整数

    lcd_set_cursor(x, y);
    for (n = 0; n < row; n++)        //换行
    {
        for (i = 0; i < width; i++) {
            lcd_set_cursor(x + i, y + n);
            lcd_write_byte(map[i + n * width], 1);
        }
    }
}

#endif